class StablecoinPredictionChart {
  constructor(canvasId) {
    this.ctx = document.getElementById(canvasId).getContext('2d');
    this.data = null;
    this.scenarioMap = ['bear', 'base', 'bull'];
    this.tickers = ['JPM', 'GS', 'XLF'];
    this.settings = {}; // {JPM: {enabled: true, scenario: 'base'}, ...}
    this.initSettings();
    this.loadData().then(() => {
      this.attachControls();
      this.createChart();
    });
  }

  initSettings() {
    this.tickers.forEach(t => {
      this.settings[t] = { enabled: true, scenario: 'base' };
    });
  }

  async loadData() {
    const resp = await fetch('stablecoin_predictions.json');
    this.data = await resp.json();
  }

  attachControls() {
    document.querySelectorAll('.ticker-control').forEach(div => {
      const t = div.dataset.ticker;
      // checkbox
      const cb = div.querySelector('.toggle-checkbox');
      cb.addEventListener('change', () => {
        this.settings[t].enabled = cb.checked;
        this.updateChart();
      });
      // slider
      const slider = div.querySelector('.scenario-slider');
      const label = div.querySelector('.scenario-label');
      slider.addEventListener('input', () => {
        const idx = parseInt(slider.value, 10);
        const scen = this.scenarioMap[idx];
        this.settings[t].scenario = scen;
        label.textContent = scen.toUpperCase();
        this.updateChart();
      });
    });
  }

  transformDatasets() {
    const years = [2025, 2026, 2027, 2028, 2029, 2030];
    return this.tickers
      .filter(t => this.settings[t].enabled)
      .map(ticker => {
        const scenario = this.settings[ticker].scenario;
        const data = years.map(year => {
          if (ticker === 'XLF') {
            const rate = this.data.etfs.XLF.growth_predictions[year][scenario];
            return year === 2025
              ? 100
              : +(100 * Math.pow(1 + rate / 100, year - 2025)).toFixed(1);
          }
          return this.data.stocks[ticker].predictions[year][scenario];
        });
        const colorMap = {
          JPM: { bull: '#10b981', base: '#3b82f6', bear: '#f59e0b' },
          GS:  { bull: '#22c55e', base: '#6366f1', bear: '#ef4444' },
          XLF:{ bull: '#8b5cf6', base: '#06b6d4', bear: '#f97316' }
        };
        return {
          label: `${ticker} ${scenario.toUpperCase()}`,
          data,
          fill: false,
          borderColor: colorMap[ticker][scenario],
          backgroundColor: colorMap[ticker][scenario],
          tension: 0.3
        };
      });
  }

  createChart() {
    const yearsLabels = [2025, 2026, 2027, 2028, 2029, 2030];
    this.chart = new Chart(this.ctx, {
      type: 'line',
      data: {
        labels: yearsLabels,
        datasets: this.transformDatasets()
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Year' } },
          y: { title: { display: true, text: 'Price / Index' } }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const val = ctx.parsed.y;
                return ctx.dataset.label.startsWith('XLF')
                  ? `Index ${val}`
                  : `$${val}`;
              }
            }
          }
        }
      }
    });
  }

  updateChart() {
    this.chart.data.datasets = this.transformDatasets();
    this.chart.update();
  }
}

// Export for module systems
if (typeof module !== 'undefined') {
  module.exports = StablecoinPredictionChart;
}
